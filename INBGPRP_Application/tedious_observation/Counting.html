{{ extends "otree/Page.html" }}
{{ load otree static }}
{{ block title }}
    Start Counting!
{{ endblock }}
{{ block content }}

    <!-- CSS -->
    <style>
        /* !! Basic css*/
        html, body {
          height: fit-content;
        }
        body {
            background: radial-gradient(#222, #000) no-repeat;
            color: white;

        }
        h1 {text-align: center}
        h2 {text-align: center}
        td {text-align: center}
        tr {text-align: right}

        /*  !! otree changes */
        .otree-timer {display: None}
        .otree-title{display: None}

        /* !! ribbons */
        .curveWrap {
          opacity: 1;
          width: 150vw;
          height: 100vh;
          position: absolute;
          transform: translateX(-30vw) rotate(0deg);
          will-change: transform;
        }
          .curveWrap .curve {
              stroke-linecap: round;
              stroke-opacity: 0;
          }
              .curveWrap .curve path {
              transform-origin: center;
              }
              .curveWrap .curve path:nth-child(1) {
                  stroke-width: 33;
                  animation: curve 35s linear 1.6s infinite;
              }
               .curveWrap .curve path:nth-child(6n + 1) {
                   stroke: #EAAA00;
              }
               .curveWrap .curve path:nth-child(6n + 2) {
                   stroke: #005EB8;
              }
               .curveWrap .curve path:nth-child(6n + 3) {
                   stroke: #FDDA24;
              }
               .curveWrap .curve path:nth-child(6n + 4) {
                   stroke: #9BD3DD;
              }
               .curveWrap .curve path:nth-child(6n + 5) {
                   stroke: #0d5257;
              }
               .curveWrap .curve path:nth-child(6n + 6) {
                   stroke: #9f7d23;
              }
               .curveWrap .curve path:nth-child(2) {
                   stroke-width: 46;
                   animation: curve 35s linear 3.2s infinite;
              }
               .curveWrap .curve path:nth-child(6n + 1) {
                   stroke: #EAAA00;
              }
               .curveWrap .curve path:nth-child(6n + 2) {
                   stroke: #005EB8;
              }
               .curveWrap .curve path:nth-child(6n + 3) {
                   stroke: #FDDA24;
              }
               .curveWrap .curve path:nth-child(6n + 4) {
                   stroke: #9BD3DD;
              }
               .curveWrap .curve path:nth-child(6n + 5) {
                   stroke: #0d5257;
              }
               .curveWrap .curve path:nth-child(6n + 6) {
                   stroke: #9f7d23;
              }
               .curveWrap .curve path:nth-child(3) {
                   stroke-width: 18;
                   animation: curve 35s linear 4.8s infinite;
              }
               .curveWrap .curve path:nth-child(6n + 1) {
                   stroke: #EAAA00;
              }
               .curveWrap .curve path:nth-child(6n + 2) {
                   stroke: #005EB8;
              }
               .curveWrap .curve path:nth-child(6n + 3) {
                   stroke: #FDDA24;
              }
               .curveWrap .curve path:nth-child(6n + 4) {
                   stroke: #9BD3DD;
              }
               .curveWrap .curve path:nth-child(6n + 5) {
                   stroke: #0d5257;
              }
               .curveWrap .curve path:nth-child(6n + 6) {
                   stroke: #9f7d23;
              }
               .curveWrap .curve path:nth-child(4) {
                   stroke-width: 34;
                   animation: curve 35s linear 6.4s infinite;
              }
               .curveWrap .curve path:nth-child(6n + 1) {
                   stroke: #EAAA00;
              }
               .curveWrap .curve path:nth-child(6n + 2) {
                   stroke: #005EB8;
              }
               .curveWrap .curve path:nth-child(6n + 3) {
                   stroke: #FDDA24;
              }
               .curveWrap .curve path:nth-child(6n + 4) {
                   stroke: #9BD3DD;
              }
               .curveWrap .curve path:nth-child(6n + 5) {
                   stroke: #0d5257;
              }
               .curveWrap .curve path:nth-child(6n + 6) {
                   stroke: #9f7d23;
              }
        @keyframes curve {
            50% {
              transform: rotateX(360deg) scaley(1) skewY(8deg);
              stroke-opacity: 1;
         }
        }

        /* !! Timer */
        /* Sets the containers height and width */
        .base-timer {
          position: relative;
        }

        /* Removes SVG styling that would hide the time label */
        .base-timer__circle {
          fill: none;
          stroke: none;
        }

        /* The SVG path that displays the timer's progress */
        .base-timer__path-elapsed {
          stroke-width: 7px;
          stroke: grey;
        }
        .base-timer__label {
            position: absolute;

            /* Size should match the parent container */
            width: inherit;
            height: inherit;

            /* Keep the label aligned to the top */
            top: 23%;
            left: 12%;

            /* Create a flexible box that centers content vertically and horizontally */
            display: flex;
            align-items: center;
            justify-content: end;

            /* Sort of an arbitrary number; adjust to your liking */
            font-size: 35px;
        }

        .base-timer__path-remaining {
              /* Just as thick as the original ring */
              stroke-width: 7px;

              /* Rounds the line endings to create a seamless circle */
              stroke-linecap: round;

              /* Makes sure the animation starts at the top of the circle */
              transform: rotate(90deg);
              transform-origin: center;

              /* One second aligns with the speed of the countdown timer */
              transition: 1s linear all;

              /* Allows the ring to change color when the color value updates */
            }
            .base-timer__path-remaining.green {
              stroke: #00f21c;
            }
            .base-timer__path-remaining.lime {
                stroke: #9bf200;
            }

            .base-timer__path-remaining.orange {
              stroke: #e8f200;
            }
            .base-timer__path-remaining.sunset{
                stroke: #fec401;
            }
            .base-timer__path-remaining.pink-lemonade {
              stroke: #e94f01;
            }
            .base-timer__path-remaining.cherry{
                stroke: #da0001
            }
        .base-timer__svg {
          /* Flips the svg and makes the animation to move left-to-right */
          transform: scaleX(-1);
        }

        /* !! Custom divs */
        #game {
            background-color: #2C2A29;
            position: relative;
            width: 100%;
            padding: 8%;
            margin-top: 5%;

        }
        #game-table{
            margin: -10%;
        }
        #game-info{
            margin-top: -5%;
        }
    </style>

    <!-- Gen HTML -->
    <body>
        <div class="curveWrap">
          <svg width="100%" height="100%" viewBox="0 0 1200 100" xmlns="http://www.w3.org/2000/svg">
            <g class="curve" fill="none">
              <!-- You can add more, fewer, and tweak paths... -->
              <path d="M 0, 60 S 300, -60, 600, 60, 800, -120, 1200 60" />
              <path d="M 0, 60 S 200, -60, 400, 60, 900, -120, 1200 60" />
              <path d="M 0, 60 S 200, -70, 400, 70, 800, -120, 1200 60" />
              <path d="M 0, 60 S 200, -60, 400, 80, 600, -120, 1200 60" />
              <path d="M 0, 60 S 400, -80, 550, 90, 800, -120, 1200 60" />
            </g>
          </svg>
        </div>
        <div id="game" class="container-xxl" >
            <div class="row">
                <div  class="col-8">
                    <table id="game-table" class = "table table-hover table-bordered table-sm">
                        <thread>
                            <tr class = "table-dark table-sm">
                                <th class="col-sm-1" scope="col">#</th>
                                <th class="border-3 col-sm-1" scope="col">1</th>
                                <th class="border-3 col-sm-1" scope="col">2</th>
                                <th class="border-3 col-sm-1" scope="col">3</th>
                                <th class="border-3 col-sm-1" scope="col">4</th>
                                <th class="border-3 col-sm-1" scope="col">5</th>
                                <th class="border-3 col-sm-1" scope="col">6</th>
                                <th class="border-3 col-sm-1" scope="col">7</th>
                                <th class="border-3 col-sm-1" scope="col">8</th>
                                <th class="border-3 col-sm-1" scope="col">9</th>
                                <th class="border-3 col-sm-1" scope="col">10</th>
                            </tr>
                        </thread>
                        <tbody id = "data_body"> </tbody>
                    </table>
                </div>
                <div id="game-info" class="col-4">
                    <div  class="row row-cols">
                        <h1>Earned: {{participant.payoff}}</h1>
                    </div>
                    <div  class="row row-cols">
                        <h2 id="feedback"></h2>
                    </div>
                    <div class="row row-cols-2">

                        <!-- Timer -->
                        <div class="col-6">
                            <span id="circle-timer"></span>
                        </div>
                        <div class="col-6">Progress</div>
                    </div>
                    <div id="bot_container2" class="row row-col">
                        <div class="col"> {{ formfields }} </div>
                    </div>
                </div>
            </div>
        </div>
    </body>

    <!-- Table Scripts -->
    <script>
         console.log("matrix: ", js_vars.matrix)
         console.log("zeros: ", js_vars.zeros)
         console.log("ones: ",js_vars.ones)
         function extract_values(string_data){
             let i = 0
             let j = i + 10
             let data = Array(15)
             let row_data = '';
             while (i < 150) {
                row_data = string_data.slice(i, j)
                data[i / 10] = Array(10).fill(0)
                for (let k = 0; k < row_data.length; k++) {
                    data[i / 10][k] = ~~row_data[k]
                }
                i += 10
                j += 10
            }
            return data
        }
        function buildTable(matrix){
             let table = document.getElementById('data_body')

             for (let i = 0; i < 15; i++){
                 let row = []
                     row =`<tr>
                             <th class = "table-bordered table-dark" scope="row">${i+1}</th>
                             <td class = "table-secondary table-bordered border-3">${matrix[i][0]}</td>
                             <td class = "table-secondary table-bordered border-3">${matrix[i][1]}</td>
                             <td class = "table-secondary table-bordered border-3">${matrix[i][2]}</td>
                             <td class = "table-secondary table-bordered border-3">${matrix[i][3]}</td>
                             <td class = "table-secondary table-bordered border-3">${matrix[i][4]}</td>
                             <td class = "table-secondary table-bordered border-3">${matrix[i][5]}</td>
                             <td class = "table-secondary table-bordered border-3">${matrix[i][6]}</td>
                             <td class = "table-secondary table-bordered border-3">${matrix[i][7]}</td>
                             <td class = "table-secondary table-bordered border-3">${matrix[i][8]}</td>
                             <td class = "table-secondary table-bordered border-3">${matrix[i][9]}</td>
                           </tr>`
                 table.innerHTML += row
             }
        }
         let data = extract_values(js_vars.matrix)
         let header = document.getElementById('feedback')
         buildTable(data)
    </script>

    <!-- Feedback -->
    <script>
         const correct = /.*Correct.*/
         const incorrect = /.*Incorrect.*/
         let feedback = js_vars.feedback

         if(feedback.match(correct)){
             document.getElementById("feedback").classList.toggle('text-success')
         }else if(feedback.match(incorrect)) {
             document.getElementById("feedback").classList.toggle('text-danger')
         }else {
             document.getElementById("feedback").classList.toggle('text-info')
         }
         header.innerHTML += feedback
    </script>

    <!--Timer scripts-->
    <script>
        let time_limit = 60; // TODO Change back to 60
        switch(~~`{{ subsession.stage }}`) {
            case 1:
                time_limit *= 10 // TODO Change back to 10
                break
            case 2:
                time_limit *= 20
                break
            case 3:
                time_limit *= 20
                break
            default:
                console.log("Problem in switch case... In counting.html. ")
                break
        }
        const INFO2_THRESHOLD = time_limit*(5/6);
        const WARNING_THRESHOLD = time_limit*(4/6);
        const WARNING2_THRESHOLD = time_limit*(3/6);
        const ALERT_THRESHOLD = time_limit*(2/6);
        const ALERT2_THRESHOLD = time_limit*(1/6);
        const FULL_CIRCLE = 283 //2 * pi * 45
        const COLOR_CODES = {
            info: { color: "green" },
            info2: {
                color: "lime",
                threshold: INFO2_THRESHOLD,
            },
            warning: {
                color: "orange",
                threshold: WARNING_THRESHOLD,
            },
            warning2: {
                color: "sunset",
                threshold: WARNING2_THRESHOLD,
            },
            alert: {
                color: "pink-lemonade",
                threshold: ALERT_THRESHOLD,
            },
            alert2: {
                color: "cherry",
                threshold: ALERT2_THRESHOLD,
            }
        };
        let remainingPathColor = COLOR_CODES.info.color;

        document.getElementById("circle-timer").innerHTML =
            `<div class="base-timer">
                <svg class="base-timer__svg" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg">
                    <g class="base-timer__circle">
                        <circle class="base-timer__path-elapsed" cx="50" cy="50" r="45" /></circle>
                        <path
                            id="base-timer-path-remaining"
                            stroke-dasharray="283"
                            class="base-timer__path-remaining ${remainingPathColor}"
                            d="
                              M 50, 50
                              m -45, 0
                              a 45,45 0 1,0 90,0
                              a 45,45 0 1,0 -90,0
                            "
                            stroke=" ${remainingPathColor}"
                          >
                        </path>
                    </g>
                </svg>
                <span id="base-timer-label" class="base-timer__label">
                    <span id="min-left"></span> : <span id="secs-left"></span>
                </span>
            </div>`;
        const zeroPad = (num, places) => String(num).padStart(places, '0')
        let minutes = document.getElementById('min-left');
        document.addEventListener("DOMContentLoaded", function (event) {
            $('.otree-timer__time-left').on('update.countdown', function (event) {
                minutes.innerText = zeroPad(event.offset.totalMinutes,2);
            });
        });
        let seconds = document.getElementById('secs-left');
        document.addEventListener("DOMContentLoaded", function (event) {
            $('.otree-timer__time-left').on('update.countdown', function (event) {
                seconds.innerText = zeroPad(event.offset.totalSeconds%60, 2);
            });
        });

        document.addEventListener("DOMContentLoaded", function (event) {
            $('.otree-timer__time-left').on('update.countdown', function (event) {
                let timeLeft = event.offset.totalSeconds;
                const circle_fraction = () => {return ((timeLeft/time_limit) * FULL_CIRCLE).toFixed(0)}
                const circle_dashArray = `${(circle_fraction())} ${FULL_CIRCLE}`;
                document.getElementById("base-timer-path-remaining").setAttribute("stroke-dasharray", circle_dashArray)

                const {alert, alert2, warning, warning2, info, info2} = COLOR_CODES
                if(timeLeft <= alert2.threshold){
                    document
                        .getElementById("base-timer-path-remaining")
                        .classList.remove(alert.color)
                    document
                        .getElementById("base-timer-path-remaining")
                        .classList.add(alert2.color)
                } else if (timeLeft <= alert.threshold){
                    document
                       .getElementById("base-timer-path-remaining")
                       .classList.remove(warning2.color)
                    document
                        .getElementById("base-timer-path-remaining")
                        .classList.add(alert.color)
                } else if (timeLeft <= warning2.threshold){
                    document
                       .getElementById("base-timer-path-remaining")
                       .classList.remove(warning.color)
                    document
                        .getElementById("base-timer-path-remaining")
                        .classList.add(warning2.color)
                } else if(timeLeft <= warning.threshold){
                    document
                       .getElementById("base-timer-path-remaining")
                       .classList.remove(info2.color)
                    document
                        .getElementById("base-timer-path-remaining")
                        .classList.add(warning.color)
                } else if(timeLeft <= info2.threshold){
                     document
                       .getElementById("base-timer-path-remaining")
                       .classList.remove(info.color)
                    document
                        .getElementById("base-timer-path-remaining")
                        .classList.add(info2.color)
                }

            });
        });
    </script>
{{ endblock }}
